global
    maxconn 100000
    log stdout format raw local0 info

defaults
    mode http
    timeout connect 5s
    timeout client 60s
    timeout server 60s
    log global

# Statistics endpoint
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s

# Backend for FastAPI instances (stateless HTTP API)
backend fastapi_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server granian1 granian1:8001 check inter 2s
    server granian2 granian2:8002 check inter 2s

# Backend for Centrifugo instances (persistent WebSocket connections)
backend centrifugo_backend
    balance leastconn
    server centrifugo1 centrifugo_node1:8100 check inter 2s
    server centrifugo2 centrifugo_node2:8200 check inter 2s

# Frontend for FastAPI HTTP API
frontend fastapi_frontend
    bind *:9000
    default_backend fastapi_backend

# Frontend for Centrifugo WebSocket and HTTP API
frontend centrifugo_frontend
    bind *:9001
    default_backend centrifugo_backend
